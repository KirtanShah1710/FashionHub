<div class="container mt-5">
  <!-- STICKY SEARCH BAR -->
  <div class="search-bar rounded-pill input-group">
    <span class="input-group-text rounded-start-4">
      <i class="bi bi-search"></i>
    </span>
    <input type="text" class="form-control p-2 rounded-end-4" placeholder="Search products..."
      [(ngModel)]="filters.search" (input)="onSearchChange()" />
  </div>

  <!-- MAIN WRAPPER -->
  <div class="products-wrapper">
    <div class="row g-0 main-row shadow-sm">
      <!-- ================= LEFT FILTERS ================= -->
      <div class="col-md-3 sidebar bg-body-tertiary">

        <!-- CATEGORY -->
        <div class="p-1 mb-2 rounded">
          <h6 class="filter-title text-secondary fw-bold" (click)="toggleFilter('category')">
            <span>Category</span>&nbsp;
            <i
              [class]="isCollapsed['category'] ? 'bi bi-caret-down-fill text-secondary' : 'bi bi-caret-up-fill text-secondary'"></i>
          </h6>
          @if(!isCollapsed['category'])
          {
          <div>
            @for(c of categories; track c.productCategoryId)
            {
            <div class="form-check">
              <input class="form-check-input" type="checkbox"
                (change)="toggleArray(filters.productCategoryId, c.productCategoryId, $any($event.target).checked)">
              <label class="form-check-label text-secondary fw-medium">{{ c.name }}</label>
            </div>
            }
          </div>
          }

        </div>



        <!-- GENDER -->
        <div class="p-1 mb-2">
          <h6 class="filter-title text-secondary fw-bold" (click)="toggleFilter('gender')">
            <span>Gender</span>&nbsp;
            <i
              [class]="isCollapsed['gender'] ? 'bi bi-caret-down-fill text-secondary' : 'bi bi-caret-up-fill text-secondary'"></i>
          </h6>
          @if(!isCollapsed['gender'])
          {
          <div>
            @for(g of genders; track g.genderId)
            {
            <div class="form-check">
              <input class="form-check-input" type="checkbox"
                (change)="toggleArray(filters.genderCategoryId, g.genderCategoryId, $any($event.target).checked)">
              <label class="form-check-label text-secondary fw-medium">{{ g.name }}</label>
            </div>
            }
          </div>
          }
        </div>



        <!-- SIZE -->
        <div class="p-1 mb-2">
          <h6 class="filter-title text-secondary fw-bold" (click)="toggleFilter('size')">
            <span>Size</span>&nbsp;
            <i [class]="isCollapsed['size'] ? 'bi bi-caret-down-fill' : 'bi bi-caret-up-fill text-secondary'"></i>
          </h6>
          @if(!isCollapsed['size'])
          {
          <div>
            @for(s of sizes; track s.sizeId)
            {
            <div class="form-check">
              <input class="form-check-input" type="checkbox"
                (change)="toggleArray(filters.sizeId, s.sizeId, $any($event.target).checked)">
              <label class="form-check-label  text-secondary fw-medium">{{ s.name }}</label>
            </div>
            }
          </div>
          }

        </div>



        <!-- COLOR -->
        <div class="p-1 mb-2">
          <h6 class="filter-title text-secondary fw-bold" (click)="toggleFilter('color')">
            <span>Color</span>&nbsp;
            <i
              [class]="isCollapsed['color'] ? 'bi bi-caret-down-fill text-secondary' : 'bi bi-caret-up-fill text-secondary'"></i>
          </h6>
          @if(!isCollapsed['color'])
          {
          <div>
            @for(c of colors; track c.colorId)
            {
            <div class="form-check">
              <input class="form-check-input" type="checkbox"
                (change)="toggleArray(filters.colorId, c.colorId, $any($event.target).checked)">
              <div class="d-flex gap-2 align-items-center">
                <div [style.background-color]="c.hexCode" style="width: 15px; height: 15px; border-radius: 50%;"
                  class="border border-1 border-black"></div>
                <label class="form-check-label text-secondary fw-medium">{{ c.name }}</label>
              </div>
            </div>
            }
          </div>
          }
        </div>



        <!-- PRICE RANGE -->
        <h6 class="filter-title text-secondary fw-bold">Price Range</h6>

        <div class="range-wrapper">
          <!-- background track -->
          <div class="range-track"></div>

          <!-- selected range -->
          <div class="range-fill" [style.left.%]="minPercent" [style.width.%]="maxPercent - minPercent">
          </div>

          <!-- MIN -->
          <input type="range" class="form-range range-input" min="0" [max]="maxPrice" step="100"
            [(ngModel)]="filters.minPrice" (input)="onPriceChange()" />

          <input type="range" class="form-range range-input" min="0" [max]="maxPrice" step="100"
            [(ngModel)]="filters.maxPrice" (input)="onPriceChange()" />
        </div>
        @if(filters.minPrice || filters.maxPrice){
        <div class="small text-muted mt-0 text-secondary fw-medium">
          <span>{{ filters.minPrice | currency:('INR') }} - {{ filters.maxPrice | currency:('INR') }}</span>
        </div>
        }

        <button class="btn btn-secondary mt-3" (click)="resetPriceRange()">Reset Price</button>
      </div>

      <!-- ================= RIGHT PRODUCT GRID ================= -->
      <div class="col-md-9 content">
        @if(products.length)
        {
        <div class="row g-3">
          <p>{{products | json}}</p>
          @for(p of products; track p.productId)
          {
          <div class="col-md-4">
            <div class="card product-card h-100 d-flex flex-column">
              <!-- IMAGE -->
              <div class="product-image-wrapper">
                <img [src]="imageBaseUrl + p.imageUrl" alt="product" />
              </div>

              <!-- BODY -->
              <div class="card-body flex-grow-1">
                <!-- COLOR LIST -->
                <div class="d-flex gap-2 justify-content-start mb-3">
                  @for(c of p.availableColors; track c.colorId)
                  {
                  <div class="rounded-circle overflow-hidden color-pDetail"
                    style="width: 40px; height: 40px; cursor:pointer;"
                    (click)="goToDetail(p.productId, c.name, p.size)">
                    <img [src]="imageBaseUrl + c.hexCode" class="w-100 h-100" style="object-fit: contain;" />
                  </div>
                  }
                </div>

                <!-- SIZE LIST -->
                <div class="d-flex gap-2 justify-content-start mb-3">
                  @for(s of p.availableSizes; track s.sizeId)
                  {
                  <div class="rounded d-flex align-items-center justify-content-center size-pDetail bg-light"
                    style="width: 30px; height: 30px; cursor:pointer;"
                    (click)="goToDetail(p.productId, p.color, s.name)">
                    {{ s.name }}
                  </div>
                  }

                </div>

                <h6 class="mb-1 fw-bold">
                  {{ p.productName }}
                </h6>

                <p class="fw-bold text-success mb-0">
                  â‚¹ {{ p.price }}
                </p>
              </div>

              <!-- FOOTER -->
              <div class="card-footer bg-white border-0 mt-auto">
                <button class="btn btn-outline-secondary fw-bold btn-sm w-100 mb-2 rounded-pill"
                  [routerLink]="['/customer/products', p.productId]">
                  View Details
                </button>
              </div>
            </div>
          </div>
          }
        </div>
        }
        @else{
        <div>
          <p class="text-center text-muted mt-5">
            No products found
          </p>
        </div>
        }
      </div>
    </div>
  </div>
</div>